name: Dependency Updates

on:
  schedule:
    # Run every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      update-type:
        description: 'Type of update'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - major
        - minor
        - patch

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Update package.json dependencies
      run: |
        # Update based on input type
        case "${{ github.event.inputs.update-type }}" in
          "major")
            npx npm-check-updates -u --packageFile package.json --semver major
            ;;
          "minor")
            npx npm-check-updates -u --packageFile package.json --semver minor
            ;;
          "patch")
            npx npm-check-updates -u --packageFile package.json --semver patch
            ;;
          *)
            npx npm-check-updates -u --packageFile package.json
            ;;
        esac

    - name: Check for changes
      id: check-changes
      run: |
        if git diff --quiet package.json package-lock.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Install updated dependencies
      if: steps.check-changes.outputs.changes == 'true'
      run: npm ci

    - name: Run tests
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        npm run lint
        npm run build
        npm run test:ci || echo "No tests found, skipping..."

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git add package.json package-lock.json
        git commit -m "chore: update dependencies
        
        - Updated npm packages
        - Ran tests and linting
        - Auto-generated by GitHub Actions"
        git push

    - name: Create Pull Request
      if: steps.check-changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: "dependencies/update-$(date +%Y%m%d-%H%M%S)"
        title: "chore: Update dependencies"
        body: |
          ## Dependency Updates
          
          This PR updates the project dependencies to their latest versions.
          
          ### Changes Made
          - Updated npm packages using `npm-check-updates`
          - Ran tests and linting to ensure compatibility
          - Updated `package.json` and `package-lock.json`
          
          ### Next Steps
          - Review the changes
          - Run the application locally to test
          - Merge if everything works correctly
          
          ### Automated Checks
          - [x] Linting passed
          - [x] Build successful
          - [x] Tests passed (if available)
          
          ---
          *This PR was automatically generated by GitHub Actions*

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      run: npm audit --audit-level moderate

    - name: Run npm audit fix
      run: npm audit fix

    - name: Check for changes
      id: check-changes
      run: |
        if git diff --quiet package.json package-lock.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit security fixes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add package.json package-lock.json
        git commit -m "security: fix vulnerabilities
        
        - Applied npm audit fixes
        - Fixed security vulnerabilities
        - Auto-generated by GitHub Actions"
        git push

    - name: Create security PR
      if: steps.check-changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: "security/fix-$(date +%Y%m%d-%H%M%S)"
        title: "security: Fix vulnerabilities"
        body: |
          ## Security Fixes
          
          This PR fixes security vulnerabilities identified by `npm audit`.
          
          ### Changes Made
          - Applied automatic security fixes using `npm audit fix`
          - Updated vulnerable packages
          - Updated `package.json` and `package-lock.json`
          
          ### Security Details
          - Ran `npm audit` to identify vulnerabilities
          - Applied automatic fixes where possible
          - Manual review may be required for complex vulnerabilities
          
          ### Next Steps
          - Review the security fixes
          - Test the application thoroughly
          - Merge if all tests pass
          
          ### Priority
          ðŸ”´ **HIGH PRIORITY** - Security fixes should be reviewed and merged quickly
          
          ---
          *This PR was automatically generated by GitHub Actions*